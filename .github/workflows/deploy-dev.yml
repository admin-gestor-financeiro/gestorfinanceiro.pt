name: Deploy â€” Dev

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    name: Deploy to Workers (dev)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build (OpenNext for Cloudflare)
        run: npx opennextjs-cloudflare build

      - name: Deploy to Workers (dev environment)
        run: npx wrangler deploy --env dev
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_DEV_RELEASE_WEBHOOK_URL }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          AUTHOR="${{ github.actor }}"
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          COMMIT_URL="https://github.com/${REPO}/commit/${COMMIT_SHA}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"

          # Collect commit messages from this push (up to 10), formatted for Discord
          COMMITS=$(git log ${{ github.event.before }}..${{ github.sha }} \
            --pretty=format:"**\`%h\`** %s â€” *%an*" | head -10)
          if [ -z "$COMMITS" ]; then
            COMMITS="**\`${SHORT_SHA}\`** ${{ github.event.head_commit.message }} â€” *${AUTHOR}*"
          fi

          # Escape for JSON
          COMMITS_ESCAPED=$(echo "$COMMITS" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")

          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸš€  Deploy Â· dev concluÃ­do\",
                \"url\": \"${RUN_URL}\",
                \"description\": ${COMMITS_ESCAPED},
                \"color\": 5763719,
                \"fields\": [
                  { \"name\": \"ðŸŒ¿  Branch\",  \"value\": \"\`${BRANCH}\`\",                        \"inline\": true },
                  { \"name\": \"ðŸ‘¤  Autor\",   \"value\": \"\`${AUTHOR}\`\",                        \"inline\": true },
                  { \"name\": \"ðŸ”—  Commit\",  \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\",    \"inline\": true }
                ],
                \"footer\": {
                  \"text\": \"gestorfinanceiro.pt  Â·  dev\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"
