name: Deploy ‚Äî Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Workers (production)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build (OpenNext for Cloudflare)
        run: npx opennextjs-cloudflare build

      - name: Deploy to Workers (production environment)
        run: npx wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_PROD_RELEASE_WEBHOOK_URL }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          AUTHOR="${{ github.actor }}"
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          COMMIT_URL="https://github.com/${REPO}/commit/${COMMIT_SHA}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"
          BEFORE="${{ github.event.before }}"

          # Handle first push to branch (before SHA is all zeros)
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            RANGE="-1"
          else
            RANGE="${BEFORE}..${COMMIT_SHA}"
          fi

          # Count total commits in this push
          TOTAL=$(git log $RANGE --oneline 2>/dev/null | wc -l | tr -d ' ')
          [ -z "$TOTAL" ] || [ "$TOTAL" -eq "0" ] && TOTAL=1

          # Build commit list: subject only, truncated at 80 chars, max 10 shown
          COMMITS=$(git log $RANGE --pretty=format:"‚Ä¢ \`%h\` %s" 2>/dev/null | \
            awk '{ if (length($0) > 85) print substr($0, 1, 82) "‚Ä¶"; else print }' | \
            head -10)

          # Fallback: use git log subject (never head_commit.message ‚Äî it includes the full body)
          if [ -z "$COMMITS" ]; then
            SUBJECT=$(git log -1 --pretty=format:"%s" "$COMMIT_SHA")
            SUBJECT="${SUBJECT:0:80}"
            COMMITS="‚Ä¢ \`${SHORT_SHA}\` ${SUBJECT}"
          fi

          # Append overflow count if there are more than 10 commits
          if [ "$TOTAL" -gt 10 ]; then
            COMMITS="${COMMITS}"$'\n'"*‚Ä¶ e mais $((TOTAL - 10)) commit(s)*"
          fi

          # Description line
          if [ "$TOTAL" -eq 1 ]; then
            DESCRIPTION="**1 commit** deployado em \`${BRANCH}\`"
          else
            DESCRIPTION="**${TOTAL} commits** deployados em \`${BRANCH}\`"
          fi

          # Escape both values for JSON
          COMMITS_JSON=$(printf '%s' "$COMMITS" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")
          DESC_JSON=$(printf '%s' "$DESCRIPTION" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")

          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"‚úÖ  Deploy ¬∑ production conclu√≠do\",
                \"url\": \"${RUN_URL}\",
                \"description\": ${DESC_JSON},
                \"color\": 16750848,
                \"fields\": [
                  { \"name\": \"üì¶  Commits\", \"value\": ${COMMITS_JSON},                                                         \"inline\": false },
                  { \"name\": \"üåø  Branch\",  \"value\": \"\`${BRANCH}\`\",                                                       \"inline\": true  },
                  { \"name\": \"üë§  Autor\",   \"value\": \"\`${AUTHOR}\`\",                                                       \"inline\": true  },
                  { \"name\": \"üîó  Commit\",  \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\",                                   \"inline\": true  },
                  { \"name\": \"üåê  Site\",    \"value\": \"[gestorfinanceiro.pt](https://gestorfinanceiro.pt)\",                  \"inline\": false }
                ],
                \"footer\": {
                  \"text\": \"gestorfinanceiro.pt  ¬∑  production\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"
